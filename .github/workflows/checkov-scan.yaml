name: Checkov Security Scan

on:
  push:
    branches:
      - main
      - develop
    paths:
      - '**.tf'
      - 'checkov_policies/**'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - '**.tf'
      - 'checkov_policies/**'
  workflow_dispatch:  # Manual trigger

permissions:
  contents: read
  security-events: write  # For uploading SARIF results
  pull-requests: write    # For PR comments

jobs:
  checkov-scan:
    name: Checkov Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Checkov
        run: |
          python -m pip install --upgrade pip
          pip install checkov
      
      - name: Display Checkov version
        run: checkov --version
      
      - name: Run Checkov scan with custom policies
        id: checkov
        run: |
          checkov -d . \
            --external-checks-dir ./checkov_policies \
            --framework terraform \
            --output cli \
            --output json \
            --output-file-path console,checkov-results.json \
            --download-external-modules true \
            --compact || true
        continue-on-error: true
      
      - name: Upload Checkov results as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: checkov-results
          path: checkov-results.json
          if-no-files-found: warn
          retention-days: 30
      
      - name: Parse Checkov results
        id: parse_results
        if: always()
        run: |
          if [ -f "checkov-results.json" ]; then
            # Extract summary from JSON results
            PASSED=$(jq '.summary.passed // 0' checkov-results.json)
            FAILED=$(jq '.summary.failed // 0' checkov-results.json)
            SKIPPED=$(jq '.summary.skipped // 0' checkov-results.json)
            
            echo "passed=$PASSED" >> $GITHUB_OUTPUT
            echo "failed=$FAILED" >> $GITHUB_OUTPUT
            echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
            
            # Count custom policy failures
            CUSTOM_FAILURES=$(jq '[.results.failed_checks[] | select(.check_id | startswith("CKV_AWS_CUSTOM"))] | length' checkov-results.json)
            echo "custom_failures=$CUSTOM_FAILURES" >> $GITHUB_OUTPUT
          else
            echo "passed=0" >> $GITHUB_OUTPUT
            echo "failed=0" >> $GITHUB_OUTPUT
            echo "skipped=0" >> $GITHUB_OUTPUT
            echo "custom_failures=0" >> $GITHUB_OUTPUT
          fi
      
      - name: Post PR comment with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const passed = '${{ steps.parse_results.outputs.passed }}';
            const failed = '${{ steps.parse_results.outputs.failed }}';
            const skipped = '${{ steps.parse_results.outputs.skipped }}';
            const customFailures = '${{ steps.parse_results.outputs.custom_failures }}';
            
            let comment = `## ðŸ” Checkov Security Scan Results\n\n`;
            comment += `| Status | Count |\n`;
            comment += `|--------|-------|\n`;
            comment += `| âœ… Passed | ${passed} |\n`;
            comment += `| âŒ Failed | ${failed} |\n`;
            comment += `| â­ï¸ Skipped | ${skipped} |\n`;
            comment += `| ðŸŽ¯ Custom Policy Failures | ${customFailures} |\n\n`;
            
            if (failed > 0) {
              comment += `### âš ï¸ Action Required\n\n`;
              comment += `There are ${failed} failed security checks. Please review the results and fix the issues.\n\n`;
              comment += `Custom policy failures: ${customFailures}\n\n`;
              comment += `Download the detailed results from the workflow artifacts.\n`;
            } else {
              comment += `### âœ… All Checks Passed!\n\n`;
              comment += `Great job! All security checks passed successfully.\n`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Check for critical violations
        if: always()
        run: |
          CUSTOM_FAILURES=${{ steps.parse_results.outputs.custom_failures }}
          
          if [ "$CUSTOM_FAILURES" -gt "0" ]; then
            echo "::error::Found $CUSTOM_FAILURES custom policy violations!"
            echo "::error::Please review and fix the security issues before merging."
            exit 1
          fi
          
          echo "::notice::No custom policy violations found!"

  checkov-custom-policies-only:
    name: Run Custom Policies Only
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Checkov
        run: pip install checkov
      
      - name: Run only custom policies
        run: |
          checkov -d . \
            --external-checks-dir ./checkov_policies \
            --check CKV_AWS_CUSTOM_001,CKV_AWS_CUSTOM_002,CKV_AWS_CUSTOM_003 \
            --framework terraform \
            --compact
        continue-on-error: false

  checkov-by-severity:
    name: Checkov - Critical & High Only
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Checkov
        run: pip install checkov
      
      - name: Run Checkov for CRITICAL issues
        id: critical
        run: |
          # S3 Public Access (CRITICAL)
          checkov -d . \
            --external-checks-dir ./checkov_policies \
            --check CKV_AWS_CUSTOM_001 \
            --framework terraform \
            --compact
        continue-on-error: false
      
      - name: Run Checkov for HIGH severity issues
        id: high
        run: |
          # EC2 Encryption (HIGH)
          checkov -d . \
            --external-checks-dir ./checkov_policies \
            --check CKV_AWS_CUSTOM_002 \
            --framework terraform \
            --compact
        continue-on-error: false

  terraform-plan-scan:
    name: Scan Terraform Plan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
      
      - name: Terraform Init
        run: terraform init
      
      - name: Terraform Plan
        run: |
          terraform plan -out=tfplan.binary
          terraform show -json tfplan.binary > tfplan.json
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Checkov
        run: pip install checkov
      
      - name: Run Checkov on Terraform Plan
        run: |
          checkov -f tfplan.json \
            --external-checks-dir ./checkov_policies \
            --framework terraform_plan \
            --compact
      
      - name: Upload Terraform Plan
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: terraform-plan
          path: |
            tfplan.json
            tfplan.binary
          retention-days: 7