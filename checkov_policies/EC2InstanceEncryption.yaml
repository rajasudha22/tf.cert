---
metadata:
  name: "Ensure EC2 instance has encrypted EBS volumes"
  id: "CKV_AWS_CUSTOM_002"
  category: "ENCRYPTION"
  severity: "HIGH"
  frameworks:
    - terraform
    - terraform_plan
  guideline: "EC2 instances must have encrypted EBS volumes to protect data at rest."
  description: |
    This policy ensures that EC2 instances are configured with encrypted EBS volumes.
    Unencrypted volumes expose sensitive data to potential security breaches.
    
    Best Practices:
    - Always enable encryption for root_block_device
    - Enable encryption for all ebs_block_device configurations
    - Use AWS KMS keys for encryption management
    - Enable encryption by default at the account level
    
    Examples:
    
    Non-Compliant (FAIL):
    resource "aws_instance" "bad_example" {
      ami           = "ami-12345678"
      instance_type = "t2.micro"
      # FAILS - No encryption specified
    }
    
    resource "aws_instance" "bad_example2" {
      ami           = "ami-12345678"
      instance_type = "t2.micro"
      
      root_block_device {
        encrypted = false  # FAILS - Explicitly disabled
      }
    }
    
    Compliant (PASS):
    resource "aws_instance" "good_example" {
      ami           = "ami-12345678"
      instance_type = "t2.micro"
      
      root_block_device {
        encrypted   = true  # PASSES
        kms_key_id  = aws_kms_key.ebs.arn
        volume_size = 20
      }
      
      ebs_block_device {
        device_name = "/dev/sdf"
        encrypted   = true  # PASSES
        volume_size = 30
      }
      
      tags = {
        Name        = "WebServer"
        Environment = "production"
        Owner       = "DevOps"
        Project     = "WebApp"
      }
    }

scope:
  provider: "aws"

definition:
  or:
    - cond_type: "attribute"
      resource_types:
        - "aws_instance"
      attribute: "root_block_device.*.encrypted"
      operator: "equals"
      value: true
    - cond_type: "attribute"
      resource_types:
        - "aws_instance"
      attribute: "ebs_block_device.*.encrypted"
      operator: "equals"
      value: true